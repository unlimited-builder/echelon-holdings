{% extends "base.html" %}

{% block content %}
<div class="min-h-[80vh] flex items-center justify-center px-6">
    <div class="w-full max-w-md glass p-10 border border-white/10">
        <div class="mb-10 text-center">
            <h2 class="text-3xl mb-2 italic">Institutional Entry</h2>
            <p class="text-xs uppercase tracking-widest text-white/40">Credential Validation Required</p>
        </div>

        <form id="login-form" class="space-y-6">
            <div>
                <label class="block text-[10px] uppercase tracking-widest text-white/40 mb-2">Institutional ID</label>
                <input type="text" id="username" required
                    class="w-full bg-white/5 border border-white/10 px-4 py-3 text-sm focus:border-[#D4AF37] transition-all">
            </div>
            <div>
                <label class="block text-[10px] uppercase tracking-widest text-white/40 mb-2">Security
                    Passphrase</label>
                <input type="password" id="password" required
                    class="w-full bg-white/5 border border-white/10 px-4 py-3 text-sm focus:border-[#D4AF37] transition-all">
            </div>

            <button type="submit"
                class="w-full gold-bg text-black py-4 font-bold uppercase tracking-widest hover:brightness-110 transition-all glow-gold">
                Connect to Terminal
            </button>
        </form>

        <div id="error-msg" class="mt-6 text-red-500 text-xs text-center font-mono hidden"></div>

        <div
            class="mt-8 pt-8 border-t border-white/5 flex justify-between items-center opacity-20 text-[10px] tracking-widest">
            <span>SECURE LINK: ESTABLISHED</span>
            <span>RSA-4096</span>
        </div>
    </div>
</div>

<script>
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorMsg = document.getElementById('error-msg');

        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password);

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('token', data.access_token);
                localStorage.setItem('role', data.role);
                // Set cookie for server-side rendering
                document.cookie = `access_token=Bearer ${data.access_token}; path=/; max-age=86400; samesite=strict`;
                window.location.href = data.role === 'admin' ? '/admin-portal' : '/dashboard';
            } else {
                const err = await response.json();
                errorMsg.textContent = err.detail || 'Access Denied';
                errorMsg.classList.remove('hidden');
            }
        } catch (e) {
            errorMsg.textContent = 'System offline or connection lost';
            errorMsg.classList.remove('hidden');
        }
    });
</script>
{% endblock %}